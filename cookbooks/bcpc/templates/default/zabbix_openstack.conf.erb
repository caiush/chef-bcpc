#
# Openstack quota monitoring 
#
UserParameter=openstack.cinder.quota,HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-cinder-user')}"%> --password=<%="#{get_config('mysql-cinder-password')}"%>  cinder -e 'select coalesce(sum(hard_limit),0) from quotas where resource="gigabytes";' | tail -n1
UserParameter=openstack.cinder.quota_usage,HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-cinder-user')}"%> --password=<%="#{get_config('mysql-cinder-password')}"%> cinder  -e 'select coalesce(sum(in_use),0) from quota_usages where resource="gigabytes";' | tail -n1
UserParameter=openstack.cinder.reserved,HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-cinder-user')}"%> --password=<%="#{get_config('mysql-cinder-password')}"%> cinder  -e 'select coalesce(sum(size),0) from volumes where deleted=0;' |  tail -n1
UserParameter=openstack.nova.rootusage,HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-nova-user')}"%> --password=<%="#{get_config('mysql-nova-password')}"%> nova  -e 'select coalesce(sum(root_gb),0) from instances where terminated_at is NULL;' | tail -n1
UserParameter=openstack.nova.quota[*],HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-nova-user')}"%> --password=<%="#{get_config('mysql-nova-password')}"%> nova  -e 'select coalesce(sum(hard_limit),0) from quotas where resource="$1";' | tail -n1
UserParameter=openstack.nova.quota_usage[*],HOME=/var/lib/zabbix mysql -u<%="#{get_config('mysql-nova-user')}"%> --password=<%="#{get_config('mysql-nova-password')}"%> nova  -e 'select coalesce(sum(in_use),0) from quota_usages where resource="$1";' | tail -n1

# 
# Checks, should return "OKAY" if everything is okay
#
UserParameter=openstack.nova.check_floats, /usr/local/bin/check_floats.py -c <%= @node["bcpc"]["floating"]["cidr"] %> -i <%=@node['bcpc']['floating']['interface']%> -u <%="#{get_config('keystone-admin-user')}"%> -p <%="#{get_config('keystone-admin-password')}"%> -l 'https://<%="#{node[:bcpc][:management][:vip]}"%>:5000/v2.0/' -t <%=@node['bcpc']['admin_tenant']%>
